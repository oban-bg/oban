# Upgrading to v2.20

This Oban release includes an optional, but recommended migration.

> #### Improve query time for pruning cancelled & discarded jobs
>
> The v13 migration needs to be run for the pruner to use indexed queries when 
> removing jobs that have been cancelled or discarded. 

## Bump Your Deps

Update Oban (and optionally Pro) to the latest versions:

```elixir
[
  {:oban, "~> 2.20"},
  {:oban_pro, "~> 1.2", repo: "oban"}
]
```

## Run Oban.Migrations for v13 (Optional)

The v13 migration adds indexes for [state, cancelled_at] and [state, discarded_at] columns. This is done
to improve the performance of the Oban.Plugins.Pruner, which prunes completed, cancelled and discarded jobs.
See (https://github.com/oban-bg/oban/commit/861dfa55e4e3e3cf65a3882baccca64c7fbcbc3d#diff-dae8a75e38cc8e3b8a29cf54657560da701f191a872e9d47c6c4fbf4c036cabcR157-R158). This will significantly improve the performance of the pruner when pruning large oban_jobs tables, with little to no impact on smaller tables.


To get started, create a migration to create the table:

```bash
$ mix ecto.gen.migration upgrade_oban_jobs_to_v13
```

Within the generated migration module:

```elixir
use Ecto.Migration

def up, do: Oban.Migrations.up(version: 13)

def down, do: Oban.Migrations.down(version: 13)
```

If you have multiple Oban instances, or use an alternate prefix, you'll need to run the migration
for each prefix.

